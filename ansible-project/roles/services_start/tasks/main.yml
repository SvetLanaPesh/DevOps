---
- name: Fix docker-compose.yml for working backend
  copy:
    dest: "{{ base_dir }}/docker-compose.yml"
    content: |
      version: '3.8'
      services:
        backend:
          image: python:3.9-slim
          command: python -m http.server 5000
          ports:
            - "5000:5000"
          volumes:
            - ./backend:/app
            
        frontend:
          image: nginx:alpine
          ports:
            - "80:80"
          volumes:
            - ./frontend:/usr/share/nginx/html

- name: Wait 30 seconds before starting services
  pause:
    seconds: 30

- name: Start microservices with docker-compose
  command: docker-compose up -d
  args:
    chdir: "{{ base_dir }}"

- name: Wait for services initialization
  pause:
    seconds: 20

- name: Check docker containers status
  command: docker-compose ps
  args:
    chdir: "{{ base_dir }}"
  register: containers_status

- name: Show containers status
  debug:
    msg: "{{ containers_status.stdout_lines }}"

- name: Check backend health with retries
  shell: |
    MAX_RETRIES=5
    for i in $(seq 1 $MAX_RETRIES); do
      echo "Attempt $i of $MAX_RETRIES..."
      STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000 2>/dev/null || echo "000")
      if [ "$STATUS" = "200" ]; then
        echo "200"
        exit 0
      fi
      sleep 3
    done
    echo "500"
  register: backend_health
  changed_when: false

- name: Check frontend health
  shell: |
    curl -s -o /dev/null -w "%{http_code}" http://localhost:80 || echo "500"
  register: frontend_health
  changed_when: false

- name: Show services health status
  debug:
    msg:
      - "Backend HTTP status: {{ backend_health.stdout }}"
      - "Frontend HTTP status: {{ frontend_health.stdout }}"

- name: Show backend logs for debugging
  shell: |
    docker logs backend-app --tail 20 2>/dev/null || echo "Cannot get backend logs"
  when: backend_health.stdout != "200"
  register: backend_logs

- name: Display backend logs
  debug:
    msg: "Backend logs: {{ backend_logs.stdout }}"
  when: backend_health.stdout != "200"

---
- name: Wait 60 seconds before starting services
  pause:
    seconds: 60

- name: Start microservices with docker-compose
  command: docker-compose up -d
  args:
    chdir: "{{ base_dir }}"
  register: docker_compose_start

- name: Wait for services initialization
  pause:
    seconds: 30

- name: Check docker containers status
  command: docker-compose ps
  args:
    chdir: "{{ base_dir }}"
  register: containers_status

- name: Show containers status
  debug:
    msg: "{{ containers_status.stdout_lines }}"

- name: Check backend health with retries
  shell: |
    for i in {1..5}; do
      if curl -s -f http://localhost:5000/data > /dev/null 2>&1; then
        echo "200"
        exit 0
      fi
      echo "Attempt $i failed, waiting 5 seconds..."
      sleep 5
    done
    echo "500"
  register: backend_health
  changed_when: false

- name: Check frontend health
  shell: |
    curl -s -o /dev/null -w "%{http_code}" http://localhost:80 || echo "500"
  register: frontend_health
  changed_when: false

- name: Show services health status
  debug:
    msg:
      - "Backend HTTP status: {{ backend_health.stdout }}"
      - "Frontend HTTP status: {{ frontend_health.stdout }}"

- name: Restart backend if not healthy
  command: docker-compose restart backend
  args:
    chdir: "{{ base_dir }}"
  when: backend_health.stdout != "200"

- name: Wait after restart if needed
  pause:
    seconds: 15
  when: backend_health.stdout != "200"
